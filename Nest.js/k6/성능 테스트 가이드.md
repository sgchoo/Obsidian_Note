[[Nest.js]]

# 성능 테스트 가이드

## 단위 테스트와 성능 테스트의 차이

### Q: 단위 테스트 코드에서 API 속도 측정을 하는게 바람직한가?

단위 테스트에서 API 속도 측정은 일반적으로 권장되지 않습니다. 그 이유는 다음과 같습니다:

1. **단위 테스트의 주 목적**: 단위 테스트는 코드의 특정 부분(단위)이 예상대로 작동하는지 기능적으로 검증하는 것이 주목적입니다. 코드가 올바른 결과를 반환하는지, 예외 처리가 제대로 되는지 등을 확인합니다.
    
2. **실행 환경의 비일관성**: 테스트 환경, CI/CD 파이프라인, 개발자 머신 등 다양한 환경에서 속도는 일관되지 않을 수 있어 신뢰할 수 있는 측정이 어렵습니다.
    
3. **오탐(false positive/negative)**: 속도 측정 테스트는 환경에 따라 가끔 실패할 수 있어 CI/CD 파이프라인의 안정성을 해칠 수 있습니다.
    

대신 다음과 같은 접근 방식을 고려해보세요:

- **성능 테스트 분리**: JMeter, Gatling, k6 등의 전용 도구를 사용한 별도의 성능 테스트 스위트 구성
- **벤치마크 테스트**: 단위 테스트와 별도로 벤치마크 테스트 스위트 구성 (예: JMH for Java)
- **프로파일링**: 실제 환경이나 스테이징 환경에서 프로파일링 도구 사용

## 성능 테스트 도구 추천

### Q: 천번의 동시 API 사용, 3000번의 API 사용 등의 성능 테스트에 적합한 라이브러리는?

다음과 같은 전용 도구들이 더 적합합니다:

1. **k6** - 현대적인 부하 테스트 도구
    
    - JavaScript로 테스트 시나리오 작성 가능
    - 동시성, 가상 사용자(VU), 램프업/다운 등 설정 가능
    - 성능 메트릭 시각화 및 분석 도구 제공
    - 확장성이 뛰어나며 클라우드 버전도 제공
2. **Apache JMeter**
    
    - 가장 널리 사용되는 오픈소스 부하 테스트 도구
    - GUI 또는 CLI 모드로 동작
    - 다양한 프로토콜 지원 (HTTP, HTTPS, WebSocket 등)
    - 분산 테스트 가능
3. **Gatling**
    
    - Scala 기반의 부하 테스트 도구
    - 코드 기반 시나리오 작성
    - 실시간 메트릭 시각화
    - 상세한 리포트 제공
4. **Autocannon** (Node.js 프로젝트에 적합)
    
    - 경량화된 Node.js HTTP/HTTPS 벤치마킹 도구
    - 명령줄 인터페이스로 간단하게 사용 가능
    - Node.js 환경에 특화됨
5. **Artillery**
    
    - Node.js 기반 부하 테스트 도구
    - YAML 설정 파일로 테스트 시나리오 작성
    - 다양한 프로토콜 지원
    - 확장 가능한 플러그인 시스템

## 대량 데이터 환경 시뮬레이션

### Q: DB에 적재된 데이터가 많을 때를 가정하고도 테스트를 할 수 있을까?

k6로 대량의 데이터 상황을 시뮬레이션하여 성능 테스트를 할 수 있습니다. 데이터가 많은 환경을 테스트하기 위한 몇 가지 접근 방법을 살펴보겠습니다:

1. **테스트 데이터 시드(Seed)하기**:
    
    - 테스트 전에 데이터베이스에 대량의 테스트 데이터를 미리 삽입
    - 테스트 완료 후 정리 가능
2. **Mock 데이터베이스 사용**:
    
    - 실제 데이터베이스를 복제하여 대량의 데이터가 있는 환경 구성
    - 프로덕션 DB를 익명화하여 테스트 환경에 복제
3. **데이터베이스 시뮬레이션**:
    
    - 서비스 계층이나 리포지토리를 모킹하여 대량 데이터 응답 시뮬레이션
    - 실제 DB 없이도 성능 테스트 진행 가능

### 테스트용 API 엔드포인트 예시:

```typescript
// 실제 서비스 대신 테스트용 컨트롤러 생성
@Controller('test')
export class TestController {
  @Get('mock-board-list')
  async getMockBoardList(
    @Query('kind') kind: number,
    @Query('page') page: number,
    @Query('limit') limit: number
  ) {
    // 대량의 데이터를 반환하는 모의 응답 생성
    const mockRecords = Array(limit).fill(0).map((_, i) => ({
      id: (page - 1) * limit + i + 1,
      title: `Test Title ${(page - 1) * limit + i + 1}`,
      content: `Test Content ${(page - 1) * limit + i + 1}`,
      createdAt: new Date(),
      // 기타 필요한 필드들...
    }));
    
    // 실제 DB 쿼리와 유사한 지연 시간 추가 (예: 많은 데이터를 처리하는 것처럼)
    await new Promise(resolve => setTimeout(resolve, 50 + Math.random() * 100));
    
    return {
      data: mockRecords,
      total: 1000000, // 백만 개의 레코드가 있다고 가정
      page,
      limit
    };
  }
}
```

## 성능 테스트 vs E2E 테스트

### Q: k6로 하는 테스트는 E2E 테스트인가?

k6를 사용한 테스트는 성능 테스트(Performance Testing) 또는 부하 테스트(Load Testing)에 해당합니다. E2E(End-to-End) 테스트와는 다른 개념입니다.

성능 테스트와 E2E 테스트의 차이점은 다음과 같습니다:

**성능/부하 테스트 (k6)**:

- 목적: 시스템의 응답 시간, 처리량, 안정성 등 성능 특성을 측정
- 중점: 동시 사용자 수 증가, 대량 요청 처리 시 시스템 동작 검증
- 측정 항목: 응답 시간, 처리량(throughput), 오류율, 자원 사용량 등
- 도구: k6, JMeter, Gatling 등

**E2E 테스트**:

- 목적: 사용자 관점에서 전체 시스템 흐름과 기능 검증
- 중점: 비즈니스 로직, 사용자 시나리오, 통합 포인트 검증
- 측정 항목: 기능 정상 작동 여부, 예상된 결과 반환 여부
- 도구: Cypress, Playwright, Selenium, Supertest 등

## k6 라이선스

### Q: k6는 유료 라이브러리인가?

k6는 기본적으로 무료 오픈소스 도구입니다. k6의 핵심 기능은 모두 무료로 사용할 수 있습니다. Grafana Labs가 인수한 이후에도 k6의 코어 기능은 계속 오픈소스로 유지되고 있습니다.

다만, 다음과 같은 상황에서는 유료 옵션이 있습니다:

1. **k6 Cloud** - 더 큰 규모의 분산 테스트, 고급 분석, 팀 협업 기능 등을 제공하는 클라우드 서비스로 유료 구독 모델입니다.
    
2. **Grafana Cloud k6** - Grafana Cloud의 일부로 제공되는 서비스로, 구독 기반 요금제입니다.
    

하지만 로컬에서 k6를 실행하고 기본적인 성능 테스트를 수행하는 데는 비용이 들지 않습니다. 대부분의 개발자와 팀은 오픈소스 버전만으로도 충분한 기능을 사용할 수 있습니다.