[[Nest.js]]

# 로드 테스트 결과 분석

## 테스트 설정 요약

- **동시 사용자(VUs)**: 1000명
- **총 반복 횟수**: 3000번
- **임계값 설정**:
    - HTTP 요청 응답 시간: 95%가 1000ms 이내(`p(95)<1000`)
    - 실패율: 10% 미만(`rate<0.1`)

## 주요 테스트 결과

```
█ THRESHOLDS
    failed_requests
    ✗ 'rate<0.1' rate=75.86%
    http_req_duration
    ✓ 'p(95)<1000' p(95)=479.15ms
  █ TOTAL RESULTS
    checks_total.......................: 1512   272.470186/s
    checks_succeeded...................: 95.76% 1448 out of 1512
    checks_failed......................: 4.23%  64 out of 1512
    ✗ status is 200
      ↳  95% — ✓ 724 / ✗ 32
    ✗ has valid JSON response
      ↳  95% — ✓ 724 / ✗ 32
    CUSTOM
    failed_requests.........................................................: 75.86% 2276 out of 3000
    HTTP
    http_req_failed.........................................................: 4.23%  32 out of 756
    http_reqs...............................................................: 756    136.235093/s
```

## 결과 분석

### 1. 임계값(THRESHOLDS) 결과

- **응답 시간(http_req_duration)**: ✓ 통과 (p(95)=479.15ms)
    - 설정한 목표인 95%의 요청이 1000ms 이내에 완료되어야 한다는 기준을 충족
    - 실제로는 95%의 요청이 479.15ms 이내에 완료됨
- **실패율(failed_requests)**: ✗ 실패 (rate=75.86%)
    - 설정한 목표인 10% 미만의 실패율에 크게 미치지 못함
    - 총 3000번의 반복 중 2276번이 실패로 기록됨

### 2. HTTP 요청 결과

- **총 HTTP 요청 수**: 756건 (총 반복 3000번 중)
- **HTTP 요청 실패율**: 4.23% (32건 실패)
- **성공한 요청의 응답 시간**: 평균 341.3ms, 최대 538.87ms

### 3. 주요 관찰 사항

#### 실패율 불일치의 원인

테스트 결과에서 가장 두드러진 특징은 두 가지 다른 실패율 지표 간의 큰 차이입니다:

- `failed_requests`: 75.86% (2276/3000)
- `http_req_failed`: 4.23% (32/756)

**이 차이가 발생한 이유**:

1. **요청 수와 반복 수의 불일치**:
    - 3000번의 반복이 시도되었지만, 실제로 서버에 도달한 HTTP 요청은 756건에 불과
    - 나머지 2244번의 반복은 HTTP 요청이 실제로 생성되지 않음
2. **실패 계산 방식**:
    - 테스트 코드의 `failureRate.add(!success)` 로직은 모든 반복에 대해 실행됨
    - HTTP 요청이 생성되지 않은 경우에도 `success`는 false로 남아있어 실패로 계산됨

#### 데이터베이스 연결 문제

초기 로그에서 발견된 데이터베이스 연결 오류:

```
Can't reach database server at `aws-0-ap-northeast-2.pooler.supabase.com:5432`
```

- **원인**: Supabase nano 요금제는 동시 연결 50개로 제한되어 있음
- **영향**: 1000명의 동시 사용자 요청이 이 제한을 크게 초과하여 많은 요청이 실패함

## 결론 및 권장 사항

### 테스트 결과 요약

- **응답 시간**: 성공적으로 처리된 요청의 응답 시간은 양호 (평균 341.3ms)
- **확장성 문제**: 시스템이 1000명의 동시 사용자를 처리하는 데 어려움을 겪음
- **병목 지점**: Supabase 데이터베이스의 동시 연결 제한 (최대 50개)

### 개선 방안

1. **데이터베이스 확장**:
    
    - Supabase의 상위 요금제로 업그레이드
    - 또는 자체 호스팅 PostgreSQL 데이터베이스 사용 고려
2. **연결 풀링 최적화**:
    
    - 효율적인 데이터베이스 연결 풀 설정
    - 커넥션 재사용 최대화
3. **캐싱 레이어 도입**:
    
    - Redis 또는 유사한 인메모리 캐시 사용
    - 자주 요청되는 데이터의 데이터베이스 부하 감소
4. **모킹 전략**:
    
    - 부하 테스트 시 실제 데이터베이스 대신 가상 데이터 사용
    - API 응답 시간에 초점을 맞춘 테스트 수행
5. **점진적 확장 테스트**:
    
    - 사용자 수를 점진적으로 증가시키며 시스템 한계 파악
    - 각 구성 요소(API, DB 등)별 병목 지점 식별