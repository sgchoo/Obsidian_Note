[[Nest.js]]

# k6 설정 및 사용 가이드 (with NestJS & TypeScript)

## 1. k6 설치

먼저 k6를 시스템에 설치해야 합니다:

**Mac (Homebrew):**

```bash
brew install k6
```

**Windows (Chocolatey):**

```bash
choco install k6
```

**Linux:**

```bash
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update
sudo apt-get install k6
```

## 2. TypeScript 설정

프로젝트에 k6용 TypeScript 환경을 설정합니다:

```bash
npm install --save-dev typescript webpack webpack-cli ts-loader @types/k6
```

## 3. webpack.config.js 생성

프로젝트 루트에 webpack.config.js 파일을 생성합니다:

```javascript
const path = require('path');

module.exports = {
  mode: 'production',
  entry: {
    'board-api-test': './performance/board-api.test.ts',
    // 추가 테스트 파일이 있다면 여기에 추가
  },
  output: {
    path: path.resolve(__dirname, 'dist/performance'),
    libraryTarget: 'commonjs',
    filename: '[name].js',
  },
  resolve: {
    extensions: ['.ts', '.js'],
  },
  module: {
    rules: [
      {
        test: /\.ts$/,
        use: 'ts-loader',
        exclude: /node_modules/,
      },
    ],
  },
  target: 'web',
  externals: /k6(\/.*)?/,
};
```

## 4. 프로젝트 구조 생성

NestJS 프로젝트 내에 성능 테스트를 위한 폴더를 생성합니다:

```
your-nestjs-project/
├── performance/
│   ├── board-api.test.ts
│   ├── helpers/
│   │   └── data-generator.ts
│   └── types/
│       └── k6.d.ts
├── webpack.config.js
└── package.json
```

## 5. k6 타입 정의 파일 작성

`performance/types/k6.d.ts` 파일에 필요한 타입 정의를 추가합니다:

```typescript
// k6.d.ts
declare module 'k6' {
  export function sleep(time: number): void;
  export function check(response: any, checks: { [key: string]: boolean }): boolean;
  export function group(name: string, fn: Function): void;
  
  export interface Options {
    vus?: number;
    iterations?: number;
    duration?: string;
    stages?: { duration: string; target: number }[];
    thresholds?: { [key: string]: string[] };
  }
}

declare module 'k6/http' {
  export interface Response {
    status: number;
    body: string;
    headers: { [key: string]: string };
    timings: {
      duration: number;
      blocked: number;
      connecting: number;
      tls_handshaking: number;
      sending: number;
      waiting: number;
      receiving: number;
    };
    json<T = any>(): T;
  }
  
  export interface RequestParams {
    headers?: { [key: string]: string };
    tags?: { [key: string]: string };
    timeout?: number;
  }
  
  export function get(url: string, params?: RequestParams): Response;
  export function post(url: string, body: string | object, params?: RequestParams): Response;
  export function put(url: string, body: string | object, params?: RequestParams): Response;
  export function del(url: string, body?: string | object, params?: RequestParams): Response;
  export function patch(url: string, body: string | object, params?: RequestParams): Response;
  export function batch(requests: { [key: string]: any }): { [key: string]: Response };
}

declare module 'k6/metrics' {
  export class Rate {
    constructor(name: string);
    add(value: number): void;
  }
  
  export class Counter {
    constructor(name: string);
    add(value: number): void;
  }
  
  export class Trend {
    constructor(name: string);
    add(value: number): void;
  }
  
  export class Gauge {
    constructor(name: string);
    add(value: number): void;
  }
}
```

## 6. 데이터 생성 헬퍼 작성

`performance/helpers/data-generator.ts` 파일에 테스트 데이터 생성 도우미 함수를 추가합니다:

```typescript
// data-generator.ts
export function generateRandomBoardData(count: number, startId: number = 1) {
  return Array(count).fill(0).map((_, index) => ({
    id: startId + index,
    title: `테스트 게시글 제목 ${startId + index}`,
    content: `이것은 테스트 게시글 내용입니다. ${startId + index}`,
    nickname: `tester${Math.floor(Math.random() * 100)}`,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    viewCount: Math.floor(Math.random() * 1000),
  }));
}
```

## 7. 성능 테스트 스크립트 작성

`performance/board-api.test.ts` 파일에 실제 테스트 스크립트를 작성합니다:

```typescript
// board-api.test.ts
import http from 'k6/http';
import { check, sleep } from 'k6';
import { Options } from 'k6';
import { generateRandomBoardData } from './helpers/data-generator';

// 테스트 설정
export const options: Options = {
  stages: [
    { duration: '30s', target: 50 },  // 30초 동안 50명의 가상 사용자로 증가
    { duration: '1m', target: 50 },   // 1분 동안 50명의 가상 사용자 유지
    { duration: '20s', target: 100 }, // 20초 동안 100명의 가상 사용자로 증가
    { duration: '1m', target: 100 },  // 1분 동안 100명의 가상 사용자 유지
    { duration: '30s', target: 0 },   // 30초 동안 0명으로 감소
  ],
  thresholds: {
    'http_req_duration': ['p(95)<500'], // 95%의 요청은 500ms 이내에 완료되어야 함
    'http_req_failed': ['rate<0.01'],   // 실패율 1% 미만
  },
};

// 테스트 데이터 초기화
export function setup() {
  // API 서버 접근 토큰이 필요한 경우
  const loginRes = http.post('http://localhost:3000/auth/login', JSON.stringify({
    email: 'test@example.com',
    password: 'password',
  }), {
    headers: { 'Content-Type': 'application/json' },
  });
  
  check(loginRes, {
    'login successful': (r) => r.status === 200,
  });
  
  const authToken = loginRes.json('token');
  
  // 대량의 테스트 데이터 생성 (선택 사항)
  if (false) { // 실제 데이터 시드가 필요한 경우 true로 변경
    const seedDataRes = http.post(
      'http://localhost:3000/test/seed',
      JSON.stringify({ count: 10000, kind: 1 }),
      {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`,
        },
      }
    );
    
    check(seedDataRes, {
      'data seeding successful': (r) => r.status === 200,
    });
  }
  
  return { authToken };
}

// 주요 테스트 함수
export default function(data: { authToken: string }) {
  // 여러 페이지에 걸쳐 무작위 접근
  const page = Math.floor(Math.random() * 20) + 1;
  const limit = 10;
  const kind = 1;
  
  const response = http.get(
    `http://localhost:3000/community/list?kind=${kind}&page=${page}&limit=${limit}`,
    {
      headers: {
        'Authorization': `Bearer ${data.authToken}`,
      },
    }
  );
  
  check(response, {
    'status is 200': (r) => r.status === 200,
    'has valid data': (r) => r.json().length !== undefined,
    'response time < 200ms': (r) => r.timings.duration < 200,
  });
  
  // 무작위 검색 시뮬레이션 (20%의 확률로 실행)
  if (Math.random() < 0.2) {
    const searchTerm = `테스트 ${Math.floor(Math.random() * 100)}`;
    
    const searchResponse = http.get(
      `http://localhost:3000/community/list?kind=${kind}&page=1&limit=${limit}&title=${encodeURIComponent(searchTerm)}`,
      {
        headers: {
          'Authorization': `Bearer ${data.authToken}`,
        },
      }
    );
    
    check(searchResponse, {
      'search status is 200': (r) => r.status === 200,
      'search response time < 300ms': (r) => r.timings.duration < 300,
    });
  }
  
  // 요청 간 지연 (실제 사용자 행동 시뮬레이션)
  sleep(Math.random() * 3 + 1); // 1-4초 사이의 무작위 지연
}

// 테스트 완료 후 정리 (선택 사항)
export function teardown(data: { authToken: string }) {
  // 테스트 데이터 정리가 필요한 경우
  if (false) { // 실제 정리가 필요한 경우 true로 변경
    const cleanupRes = http.post(
      'http://localhost:3000/test/cleanup',
      JSON.stringify({ kind: 1 }),
      {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${data.authToken}`,
        },
      }
    );
    
    check(cleanupRes, {
      'cleanup successful': (r) => r.status === 200,
    });
  }
}
```

## 8. 패키지 스크립트 설정

`package.json`에 테스트 실행 스크립트를 추가합니다:

```json
{
  "scripts": {
    "perf:build": "webpack",
    "perf:board": "npm run perf:build && k6 run dist/performance/board-api-test.js",
    "perf:report": "k6 run --out json=results.json dist/performance/board-api-test.js"
  }
}
```

## 9. 테스트용 엔드포인트 생성 (선택사항)

테스트 데이터 시드를 위한 NestJS 컨트롤러를 추가합니다:

```typescript
// test.controller.ts
import { Controller, Post, Body, UseGuards } from '@nestjs/common';
import { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';
import { BoardService } from '../board/board.service';

@Controller('test')
export class TestController {
  constructor(private readonly boardService: BoardService) {}

  @UseGuards(JwtAuthGuard)
  @Post('seed')
  async seedTestData(@Body() body: { count: number; kind: number }) {
    const { count, kind } = body;
    // 여기서 테스트 데이터를 생성하는 로직 구현
    // 실제 프로덕션에서는 비활성화해야 함
    
    return { success: true, seedCount: count };
  }

  @UseGuards(JwtAuthGuard)
  @Post('cleanup')
  async cleanupTestData(@Body() body: { kind: number }) {
    const { kind } = body;
    // 여기서 테스트 데이터를 정리하는 로직 구현
    
    return { success: true };
  }
}
```

## 10. 테스트 실행

모든 설정이 완료되면 다음 명령어로 성능 테스트를 실행합니다:

```bash
npm run perf:board
```

더 자세한 결과를 보려면:

```bash
npm run perf:report
```

## 11. 대량 데이터 시뮬레이션 방법

실제 DB에 많은 데이터가 없을 때도 대용량 환경을 시뮬레이션하는 방법:

### 방법 1: 테스트 데이터 시드

```typescript
// setup.js - 테스트 데이터 생성
import http from 'k6/http';
import { check } from 'k6';

export function setup() {
  // 테스트 데이터 생성을 위한 API 호출
  const response = http.post('http://your-api/seed-test-data', JSON.stringify({
    recordCount: 100000, // 생성할 레코드 수
    boardType: 1
  }), {
    headers: { 'Content-Type': 'application/json' },
  });
  
  check(response, {
    'Data seeding successful': (r) => r.status === 200,
  });
  
  return { dataSeeded: true };
}
```

### 방법 2: 모의 API 엔드포인트 사용

```typescript
// test.controller.ts
@Controller('test')
export class TestController {
  @Get('mock-board-list')
  async getMockBoardList(
    @Query('kind') kind: number,
    @Query('page') page: number,
    @Query('limit') limit: number
  ) {
    // 대량의 데이터를 반환하는 모의 응답 생성
    const mockRecords = Array(limit).fill(0).map((_, i) => ({
      id: (page - 1) * limit + i + 1,
      title: `Test Title ${(page - 1) * limit + i + 1}`,
      content: `Test Content ${(page - 1) * limit + i + 1}`,
      createdAt: new Date(),
      // 기타 필요한 필드들...
    }));
    
    // 실제 DB 쿼리와 유사한 지연 시간 추가
    await new Promise(resolve => setTimeout(resolve, 50 + Math.random() * 100));
    
    return {
      data: mockRecords,
      total: 1000000, // 백만 개의 레코드가 있다고 가정
      page,
      limit
    };
  }
}
```

## 12. 결과 분석 및 시각화

k6는 다양한 형식으로 결과를 출력할 수 있습니다:

```bash
# JSON 형식으로 결과 저장
k6 run --out json=results.json dist/performance/board-api-test.js

# InfluxDB로 결과 전송 (Grafana와 함께 사용 가능)
k6 run --out influxdb=http://localhost:8086/k6 dist/performance/board-api-test.js

# CSV 형식으로 결과 저장
k6 run --out csv=results.csv dist/performance/board-api-test.js
```

Grafana와 함께 사용하면 더 풍부한 시각화 가능:

1. InfluxDB 설치
2. Grafana 설치
3. k6 결과를 InfluxDB로 전송
4. Grafana에서 InfluxDB 데이터 소스를 사용하여 대시보드 구성